
{{define "title"}}设备管理{{end}}

{{define "devices_content"}}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-microchip"></i> 设备管理
        </h1>
    </div>
</div>

<!-- 设备列表 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">设备列表</h6>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="fas fa-plus"></i> 添加设备
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="devicesTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>设备ID</th>
                                <th>设备名称</th>
                                <th>类型</th>
                                <th>位置</th>
                                <th>状态</th>
                                <th>最后更新</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Devices}}
                            <tr>
                                <td>{{.ID}}</td>
                                <td>{{.Name}}</td>
                                <td>{{.Type}}</td>
                                <td>{{.LocationAddress}}</td>
                                <td>
                                    <span class="badge {{if eq .Status "online"}}bg-success{{else if eq .Status "offline"}}bg-danger{{else}}bg-secondary{{end}}">
                                        {{.Status}}
                                    </span>
                                </td>
                                <td>{{.UpdatedAt.Format "2006-01-02 15:04:05"}}</td>
                                <td>
                                    <a href="/devices/{{.ID}}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editDevice('{{.ID}}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice('{{.ID}}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                {{if gt .Pagination.TotalPages 1}}
                <nav aria-label="设备列表分页">
                    <ul class="pagination justify-content-center">
                        {{if gt .Pagination.CurrentPage 1}}
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="goToPage({{.Pagination.CurrentPage}} - 1)">上一页</a>
                        </li>
                        {{end}}
                        
                        <li class="page-item active">
                            <span class="page-link">{{.Pagination.CurrentPage}} / {{.Pagination.TotalPages}}</span>
                        </li>
                        
                        {{if lt .Pagination.CurrentPage .Pagination.TotalPages}}
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="goToPage({{.Pagination.CurrentPage}} + 1)">下一页</a>
                        </li>
                        {{end}}
                    </ul>
                </nav>
                {{end}}
            </div>
        </div>
    </div>
</div>

<!-- 添加设备模态框 -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addDeviceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">设备名称</label>
                        <input type="text" class="form-control" id="deviceName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="deviceType" class="form-label">设备类型</label>
                        <select class="form-select" id="deviceType" name="type" required>
                            <option value="">请选择设备类型</option>
                            <option value="air_quality">空气质量监测器</option>
                            <option value="weather">气象站</option>
                            <option value="industrial">工业监测器</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="deviceLocation" class="form-label">安装位置</label>
                        <input type="text" class="form-control" id="deviceLocation" name="location_address">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceLatitude" class="form-label">纬度</label>
                                <input type="number" class="form-control" id="deviceLatitude" name="location_latitude" step="0.000001">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceLongitude" class="form-label">经度</label>
                                <input type="number" class="form-control" id="deviceLongitude" name="location_longitude" step="0.000001">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">添加设备</button>
                </div>
            </form>
        </div>
    </div>
</div>
{{end}}

{{define "devices_scripts"}}
<script>
// 添加设备
document.getElementById('addDeviceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const deviceData = Object.fromEntries(formData);
    
    fetch('/api/v1/devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('设备添加成功！');
            location.reload();
        } else {
            alert('设备添加失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('设备添加失败：网络错误');
    });
});

// 编辑设备
function editDevice(deviceId) {
    // TODO: 实现编辑设备功能
    alert('编辑设备功能待实现');
}

// 删除设备
function deleteDevice(deviceId) {
    if (confirm('确定要删除这个设备吗？')) {
        fetch(`/api/v1/devices/${deviceId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('设备删除成功！');
                location.reload();
            } else {
                alert('设备删除失败：' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('设备删除失败：网络错误');
        });
    }
}

// 分页跳转
function goToPage(page) {
    const url = new URL(window.location);
    url.searchParams.set('page', page);
    window.location.href = url.toString();
}
</script>
{{end}}
