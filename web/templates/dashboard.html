{{define "dashboard_content"}}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-tachometer-alt"></i> 系统仪表板
            <small class="text-muted">{{.CurrentTime}}</small>
        </h1>
    </div>
</div>
<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            总设备数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{.DeviceStats.TotalDevices}}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-microchip fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            在线设备
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{.DeviceStats.OnlineDevices}}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-wifi fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            活跃告警
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{.AlertStats.UnresolvedAlerts}}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            数据点总数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{len .LatestData}}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-database fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 最新数据表格 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    最新数据
                    <small class="text-muted ms-2" id="refreshStatus">
                        <i class="fas fa-sync-alt fa-spin"></i> 每20秒自动刷新
                    </small>
                </h6>
                <a href="/sensor-data" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i> 查看全部
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>设备ID</th>
                                <th>设备类型</th>
                                <th>传感器ID</th>
                                <th>PM2.5</th>
                                <th>甲醛</th>
                                <th>温度</th>
                                <th>湿度</th>
                                <th>电池</th>
                                <th>状态</th>
                                <th>更新时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .LatestData}}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{.DeviceID}}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{.DeviceType}}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{.SensorID}}</small>
                                </td>
                                <td>
                                    {{if gt .PM25 0}}
                                    <span class="badge {{if gt .PM25 75}}bg-danger{{else if gt .PM25 35}}bg-warning{{else}}bg-success{{end}}">
                                        {{printf "%.1f" .PM25}} μg/m³
                                    </span>
                                    {{else}}
                                    <span class="text-muted">-</span>
                                    {{end}}
                                </td>
                                <td>
                                    {{if gt .Formaldehyde 0}}
                                    <span class="badge {{if gt .Formaldehyde 0.1}}bg-danger{{else if gt .Formaldehyde 0.05}}bg-warning{{else}}bg-success{{end}}">
                                        {{printf "%.3f" .Formaldehyde}} mg/m³
                                    </span>
                                    {{else}}
                                    <span class="text-muted">-</span>
                                    {{end}}
                                </td>
                                <td>
                                    {{if gt .Temp 0}}
                                    {{printf "%.1f" .Temp}}°C
                                    {{else}}
                                    <span class="text-muted">-</span>
                                    {{end}}
                                </td>
                                <td>
                                    {{if gt .Humidity 0}}
                                    {{printf "%.1f" .Humidity}}%
                                    {{else}}
                                    <span class="text-muted">-</span>
                                    {{end}}
                                </td>
                                <td>
                                    {{if gt .Battery 0}}
                                    <span class="badge {{if lt .Battery 20}}bg-danger{{else if lt .Battery 50}}bg-warning{{else}}bg-success{{end}}">
                                        {{.Battery}}%
                                    </span>
                                    {{else}}
                                    <span class="text-muted">-</span>
                                    {{end}}
                                </td>
                                <td>
                                    <span class="badge {{if eq .Status "online"}}bg-success{{else}}bg-secondary{{end}}">
                                        {{.Status}}
                                    </span>
                                </td>
                                <td>
                                    <small>{{.CreatedAt.Format "15:04:05"}}</small>
                                </td>
                                <td>
                                    <a href="/sensor-data?device_id={{.DeviceID}}&sensor_id={{.SensorID}}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 快速操作 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">快速操作</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="/devices" class="btn btn-outline-primary btn-lg w-100">
                            <i class="fas fa-microchip fa-2x mb-2"></i><br>
                            设备管理
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/sensor-data" class="btn btn-outline-success btn-lg w-100">
                            <i class="fas fa-database fa-2x mb-2"></i><br>
                            数据查看
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/charts" class="btn btn-outline-info btn-lg w-100">
                            <i class="fas fa-chart-line fa-2x mb-2"></i><br>
                            图表分析
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/alerts" class="btn btn-outline-warning btn-lg w-100">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>
                            告警管理
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 自动刷新功能 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let refreshCountdown = 20;
    
    // 启动倒计时
    const countdownInterval = setInterval(function() {
        refreshCountdown--;
        updateRefreshStatus(refreshCountdown);
        
        if (refreshCountdown <= 0) {
            refreshDashboardData();
            refreshCountdown = 20; // 重置倒计时
        }
    }, 1000);
    
    // 每20秒自动刷新数据
    setInterval(function() {
        refreshDashboardData();
    }, 20000);
    
    // 页面可见性变化时刷新
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            refreshDashboardData();
            refreshCountdown = 20; // 重置倒计时
        }
    });
});

function updateRefreshStatus(seconds) {
    const refreshStatus = document.getElementById('refreshStatus');
    if (refreshStatus && !refreshStatus.innerHTML.includes('正在刷新') && !refreshStatus.innerHTML.includes('已更新') && !refreshStatus.innerHTML.includes('刷新失败')) {
        refreshStatus.innerHTML = `<i class="fas fa-sync-alt"></i> ${seconds}秒后刷新`;
    }
}

function refreshDashboardData() {
    // 更新刷新状态
    const refreshStatus = document.getElementById('refreshStatus');
    if (refreshStatus) {
        refreshStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> 正在刷新...';
    }
    
    // 显示加载状态
    const tableBody = document.querySelector('#dataTable tbody');
    if (tableBody) {
        const loadingRow = document.createElement('tr');
        loadingRow.innerHTML = '<td colspan="11" class="text-center"><i class="fas fa-spinner fa-spin"></i> 正在刷新数据...</td>';
        tableBody.insertBefore(loadingRow, tableBody.firstChild);
    }
    
    // 获取最新数据
    fetch('/web/api/latest-data')
        .then(response => response.json())
        .then(data => {
            if (data && Array.isArray(data)) {
                updateDashboardTable(data);
                // 更新刷新状态为成功
                if (refreshStatus) {
                    refreshStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> 已更新';
                    setTimeout(() => {
                        refreshStatus.innerHTML = '<i class="fas fa-sync-alt"></i> 20秒后刷新';
                    }, 2000);
                }
            }
        })
        .catch(error => {
            console.error('刷新数据失败:', error);
            // 移除加载状态
            const loadingRow = tableBody.querySelector('tr:first-child');
            if (loadingRow && loadingRow.innerHTML.includes('正在刷新数据')) {
                loadingRow.remove();
            }
            // 更新刷新状态为失败
            if (refreshStatus) {
                refreshStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> 刷新失败';
                setTimeout(() => {
                    refreshStatus.innerHTML = '<i class="fas fa-sync-alt"></i> 20秒后刷新';
                }, 3000);
            }
        });
}

function updateDashboardTable(data) {
    const tableBody = document.querySelector('#dataTable tbody');
    if (!tableBody) return;
    
    // 清空现有数据
    tableBody.innerHTML = '';
    
    // 添加新数据
    data.forEach(item => {
        const row = document.createElement('tr');
        
        // 格式化时间
        const updateTime = new Date(item.created_at).toLocaleTimeString('zh-CN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        // 格式化数值
        const formatValue = (value, decimals = 1) => {
            return value > 0 ? value.toFixed(decimals) : '-';
        };
        
        // 获取状态颜色
        const getStatusBadge = (status) => {
            return status === 'online' ? 'bg-success' : 'bg-secondary';
        };
        
        // 获取PM2.5颜色
        const getPM25Badge = (value) => {
            if (value <= 0) return 'text-muted';
            if (value > 75) return 'bg-danger';
            if (value > 35) return 'bg-warning';
            return 'bg-success';
        };
        
        // 获取甲醛颜色
        const getFormaldehydeBadge = (value) => {
            if (value <= 0) return 'text-muted';
            if (value > 0.1) return 'bg-danger';
            if (value > 0.05) return 'bg-warning';
            return 'bg-success';
        };
        
        // 获取电池颜色
        const getBatteryBadge = (value) => {
            if (value <= 0) return 'text-muted';
            if (value < 20) return 'bg-danger';
            if (value < 50) return 'bg-warning';
            return 'bg-success';
        };
        
        row.innerHTML = `
            <td><span class="badge bg-secondary">${item.device_id}</span></td>
            <td><span class="badge bg-info">${item.device_type}</span></td>
            <td><small class="text-muted">${item.sensor_id}</small></td>
            <td>
                ${item.pm25 > 0 ? 
                    `<span class="badge ${getPM25Badge(item.pm25)}">${formatValue(item.pm25)} μg/m³</span>` : 
                    '<span class="text-muted">-</span>'
                }
            </td>
            <td>
                ${item.formaldehyde > 0 ? 
                    `<span class="badge ${getFormaldehydeBadge(item.formaldehyde)}">${formatValue(item.formaldehyde, 3)} mg/m³</span>` : 
                    '<span class="text-muted">-</span>'
                }
            </td>
            <td>${formatValue(item.temp)}°C</td>
            <td>${formatValue(item.humidity)}%</td>
            <td>
                ${item.battery > 0 ? 
                    `<span class="badge ${getBatteryBadge(item.battery)}">${item.battery}%</span>` : 
                    '<span class="text-muted">-</span>'
                }
            </td>
            <td><span class="badge ${getStatusBadge(item.status)}">${item.status}</span></td>
            <td><small>${updateTime}</small></td>
            <td>
                <a href="/sensor-data?device_id=${item.device_id}&sensor_id=${item.sensor_id}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                </a>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // 更新统计信息
    updateStatistics(data);
}

function updateStatistics(data) {
    // 更新数据点总数
    const dataCountElement = document.querySelector('.h5.mb-0.font-weight-bold.text-gray-800');
    if (dataCountElement && dataCountElement.textContent.includes('条记录')) {
        dataCountElement.textContent = data.length;
    }
    
    // 更新在线设备数
    const onlineCount = data.filter(item => item.status === 'online').length;
    const onlineElement = document.querySelector('.col-xl-3:nth-child(2) .h5.mb-0');
    if (onlineElement) {
        onlineElement.textContent = onlineCount;
    }
}
</script>
{{end}}